// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
/*
 * Copyright 2018 Boundary Devices
 */

/dts-v1/;
#define MX8MMN(a, b)	MX8MM_##a b
#define IMX8MMN(a)	IMX8MM_##a
#include "fsl-imx8mm.dtsi"
#include "imx8mmn-nitrogen8mm.dtsi"

&iomuxc {
	/* mcp2515t: can controller */
	pinctrl_ecspi2_mcp2515t: ecspi2-mcp2515tgrp {
		fsl,pins = <
#define GPIRQ_MCP2515T	<&gpio4 14 IRQ_TYPE_LEVEL_LOW>
			MX8MMN(IOMUXC_SAI1_TXD2_GPIO4_IO14, 0x1c0)
#define GP_MCP2515T_RESET <&gpio4 1 GPIO_ACTIVE_LOW>
			MX8MMN(IOMUXC_SAI1_RXC_GPIO4_IO1, 0x100)
#define GP_CAN_ERR	<&gpio4 15 GPIO_ACTIVE_LOW>
			MX8MMN(IOMUXC_SAI1_TXD3_GPIO4_IO15, 0x1c0)
#define GP_CAN_EN	<&gpio3 19 GPIO_ACTIVE_HIGH>
			MX8MMN(IOMUXC_SAI5_RXFS_GPIO3_IO19, 0x100)
                >;
        };

	pinctrl_pcie0: pcie0grp {
		fsl,pins = <
#define GP_PCIE0_RESET		<&gpio4 31 GPIO_ACTIVE_LOW>
			MX8MMN(IOMUXC_SAI3_TXFS_GPIO4_IO31, 0x100)
#define GP_PCIE0_DISABLE	<&gpio1 4 GPIO_ACTIVE_LOW>
			MX8MMN(IOMUXC_GPIO1_IO04_GPIO1_IO4, 0x100)
		>;
	};

	pinctrl_sai1: sai1grp {
		fsl,pins = <
			/* wm8960 */
			MX8MMN(IOMUXC_SAI1_MCLK_SAI1_MCLK, 0xd6)
			MX8MMN(IOMUXC_SAI1_TXFS_SAI1_TX_SYNC, 0xd6)
			MX8MMN(IOMUXC_SAI1_TXC_SAI1_TX_BCLK, 0xd6)
			MX8MMN(IOMUXC_SAI1_TXD0_SAI1_TX_DATA0, 0xd6)
			MX8MMN(IOMUXC_SAI1_RXD0_SAI1_RX_DATA0, 0xd6)
		>;
	};

	pinctrl_usbotg2: usbotg2grp {
		fsl,pins = <
			MX8MMN(IOMUXC_GPIO1_IO14_USB2_OTG_PWR, 0x16)
			MX8MMN(IOMUXC_GPIO1_IO15_USB2_OTG_OC, 0x16)
		>;
	};
};

/ {
	model = "Boundary Devices i.MX8MMini Nitrogen8MM";
	compatible = "boundary,imx8mm-nitrogen8mm", "fsl,imx8mm";

	clocks {
		clk16m: clk16m {
			compatible = "fixed-clock";
			#clock-cells = <0>;
			clock-frequency = <16000000>;
		};
	};

	sound-wm8960 {
		compatible = "fsl,imx-audio-wm8960";
		model = "wm8960-audio";
		cpu-dai = <&sai1>;
		codec-master;
		audio-codec = <&wm8960>;
		audio-routing =
			"Headphone Jack", "HP_L",
			"Headphone Jack", "HP_R",
			"Ext Spk", "SPK_LP",
			"Ext Spk", "SPK_LN",
			"Ext Spk", "SPK_RP",
			"Ext Spk", "SPK_RN",
			"LINPUT1", "Main MIC",
			"Main MIC", "MICB",
			"RINPUT1", "Mic Jack",
			"Mic Jack", "MICB";
		/* JD2: hp detect high for headphone*/
		hp-det = <2 0>;
		hp-det-gpios = GP_WM8960_HP_DET;
#if 0		/* Jack is not stuffed */
		mic-det-gpios = GP_WM8960_MIC_DET;
#endif
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_sound_wm8960>;
	};
};

&csi1_bridge {
	fsl,mipi-mode;
	status = "okay";

	port {
		csi1_ep: endpoint {
			remote-endpoint = <&csi1_mipi_ep>;
		};
	};
};

&ecspi2 {
	can0: can@0 {
		clocks = <&clk16m>;
		compatible = "microchip,mcp2515";
		interrupts-extended = GPIRQ_MCP2515T;
		pinctrl-names = "default";
		pinctrl-0 = <&pinctrl_ecspi2_mcp2515t>;
		reg = <0>;
		reset-gpios = GP_MCP2515T_RESET;
		spi-max-frequency = <10000000>;
		xceiver-gpios = GP_CAN_EN;
	};
};

&i2c4 {
	wm8960: codec@1a {
		compatible = "wlf,wm8960";
		reg = <0x1a>;
		clocks = <&clk IMX8MMN(CLK_SAI1_ROOT)>;
		clock-names = "mclk";
		wlf,shared-lrclk;
	};
};

&pcie0 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_pcie0>;
	disable-gpio = GP_PCIE0_DISABLE;
	reset-gpio = GP_PCIE0_RESET;
	ext_osc = <0>;
	status = "okay";
};

&sai1 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_sai1>;
	assigned-clocks = <&clk IMX8MMN(CLK_SAI1)>;
	assigned-clock-parents = <&clk IMX8MMN(AUDIO_PLL1_OUT)>;
	assigned-clock-rates = <12288000>;
	status = "okay";
};

&usbotg2 {
	pinctrl-names = "default";
	pinctrl-0 = <&pinctrl_usbotg2>;
	power-polarity-active-high;
	dr_mode = "host";
	status = "okay";
};

&vpu_g1 {
	status = "okay";
};

&vpu_g2 {
	status = "okay";
};

&vpu_h1 {
	status = "okay";
};

&vpumix_pd {
	dvfs-supply = <&reg_sw5>;
	idle-microvolt = <850000 805000 900000>;
};
